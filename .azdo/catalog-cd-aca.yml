name: 03-02-catalog-cd-aca

# trigger:
#   branches:
#     include:
#       - master
#   paths:
#     include:
#       - apps/catalog-api/*

trigger: none
pr: none

pool:
  vmImage: "ubuntu-latest"

variables:
  acrName: "az400acrdev"
  image: "az400acrdev.azurecr.io/catalog-service"
  app: "catalog-service-v1"
  grp: "az400-dev"
  serviceConnection: wi-az400-dev
  acaenv: "az400acaenv"

stages:
  - stage: Deploy
    jobs:
      - job: Deploy
        displayName: Deploy to ACA
        steps:
          - checkout: none
          - task: AzureCLI@2
            displayName: Fetch ACR credentials
            inputs:
              azureSubscription: "$(serviceConnection)"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                # Fetch ACR admin credentials and surface password as pipeline variable
                ACR_PASSWORD=$(az acr credential show --name $(acrName) --query "passwords[0].value" -o tsv)
                echo "##vso[task.setvariable variable=acrPassword;issecret=true]${ACR_PASSWORD}"

          - task: AzureCLI@2
            inputs:
              azureSubscription: "$(serviceConnection)"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                az containerapp create -n $(app) -g $(grp) --image $(image) \
                    --environment $(acaenv) \
                    --target-port 8080 \
                    --ingress external \
                    --registry-server $(acrName).azurecr.io \
                    --registry-username $(acrName) \
                    --registry-password $(acrPassword)
